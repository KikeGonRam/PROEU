{% extends "base.html" %}

{% block title %}Gestión de Usuarios - Sistema de Solicitudes de Pagos{% endblock %}

{% block page_title %}Gestión de Usuarios{% endblock %}
{% block page_description %}Administrar usuarios del sistema{% endblock %}

{% block header_actions %}
<div class="flex space-x-3">
    <button onclick="openAddUserModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        <i class="fas fa-plus mr-2"></i>
        Nuevo Usuario
    </button>
    <button onclick="refreshUsers()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        <i class="fas fa-sync-alt mr-2"></i>
        Actualizar
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Filtros y búsqueda -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Búsqueda -->
            <div class="md:col-span-2">
                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>
                    Buscar usuarios
                </label>
                <input type="text" id="searchInput" 
                       placeholder="Buscar por nombre, email o departamento..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            </div>
            
            <!-- Filtro por rol -->
            <div>
                <label for="roleFilter" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user-tag mr-1"></i>
                    Rol
                </label>
                <select id="roleFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Todos los roles</option>
                    <option value="admin">Administrador</option>
                    <option value="solicitante">Solicitante</option>
                    <option value="aprobador">Aprobador</option>
                    <option value="pagador">Pagador</option>
                </select>
            </div>
            
            <!-- Filtro por estado -->
            <div>
                <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-toggle-on mr-1"></i>
                    Estado
                </label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Todos los estados</option>
                    <option value="active">Activo</option>
                    <option value="inactive">Inactivo</option>
                    <option value="suspended">Suspendido</option>
                </select>
            </div>
        </div>
        
        <div class="mt-4 flex justify-between items-center">
            <button onclick="applyFilters()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-filter mr-2"></i>
                Aplicar Filtros
            </button>
            <button onclick="clearFilters()" class="text-sm text-gray-500 hover:text-gray-700">
                <i class="fas fa-times mr-1"></i>
                Limpiar filtros
            </button>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-users mr-2 text-blue-600"></i>
                    Lista de Usuarios
                </h3>
                <div class="text-sm text-gray-500" id="userCount">
                    <!-- Usuario count will be loaded here -->
                </div>
            </div>
            
            <!-- Loading state -->
            <div id="loadingUsers" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">Cargando usuarios...</p>
            </div>
            
            <!-- Users table -->
            <div id="usersTableContainer" class="hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Usuario
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Departamento
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Rol
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Último Acceso
                                </th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Anterior
                        </button>
                        <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Siguiente
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700" id="paginationInfo">
                                <!-- Pagination info will be loaded here -->
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="paginationNav">
                                <!-- Pagination buttons will be loaded here -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Empty state -->
            <div id="emptyState" class="hidden text-center py-8">
                <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay usuarios</h3>
                <p class="text-gray-500 mb-4">Comienza agregando el primer usuario al sistema.</p>
                <button onclick="openAddUserModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700">
                    <i class="fas fa-plus mr-2"></i>
                    Agregar Usuario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar/editar usuario -->
<div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal header -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">
                    <i class="fas fa-user-plus mr-2 text-blue-600"></i>
                    Nuevo Usuario
                </h3>
                <button onclick="closeUserModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Form -->
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId" name="userId">
                
                <!-- Nombre -->
                <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nombre <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="firstName" name="firstName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Apellido -->
                <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
                        Apellido <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="lastName" name="lastName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                        Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Departamento -->
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="department" name="department" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Teléfono -->
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                        Teléfono
                    </label>
                    <input type="tel" id="phone" name="phone"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <!-- Rol -->
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-1">
                        Rol <span class="text-red-500">*</span>
                    </label>
                    <select id="role" name="role" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Seleccionar rol</option>
                        <option value="admin">Administrador</option>
                        <option value="solicitante">Solicitante</option>
                        <option value="aprobador">Aprobador</option>
                        <option value="pagador">Pagador</option>
                    </select>
                </div>
                
                <!-- Estado -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
                        Estado <span class="text-red-500">*</span>
                    </label>
                    <select id="status" name="status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Seleccionar estado</option>
                        <option value="active">Activo</option>
                        <option value="inactive">Inactivo</option>
                        <option value="suspended">Suspendido</option>
                    </select>
                </div>
                
                <!-- Contraseña (solo para nuevo usuario) -->
                <div id="passwordField">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                        Contraseña <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="password" name="password"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                </div>
                
                <!-- Botones -->
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeUserModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Cancelar
                    </button>
                    <button type="submit" id="submitButton"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-save mr-2"></i>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalles del Usuario -->
<div id="userDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between border-b pb-4 mb-6">
            <h3 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-user-circle text-blue-500 mr-3"></i>
                Información del Usuario
            </h3>
            <button onclick="closeUserDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Contenido del modal -->
        <div class="space-y-6">
            <!-- Información Personal -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
                <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user text-blue-600 mr-2"></i>
                    Información Personal
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-id-card text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Nombre Completo:</span>
                            <p id="detailFullName" class="font-medium text-gray-900"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-envelope text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Email:</span>
                            <p id="detailEmail" class="font-medium text-gray-900 break-all"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-phone text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Teléfono:</span>
                            <p id="detailPhone" class="font-medium text-gray-900"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-building text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Departamento:</span>
                            <p id="detailDepartment" class="font-medium text-gray-900"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado y Rol -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-4">
                <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-cog text-green-600 mr-2"></i>
                    Estado y Permisos
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-user-tag text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Rol:</span>
                            <p id="detailRole" class="font-medium"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-circle text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Estado:</span>
                            <p id="detailStatus" class="font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fechas -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4">
                <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-calendar text-purple-600 mr-2"></i>
                    Información Temporal
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-calendar-plus text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Fecha de Creación:</span>
                            <p id="detailCreatedAt" class="font-medium text-gray-900"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-clock text-gray-500 w-4"></i>
                        <div>
                            <span class="text-sm text-gray-500">Último Acceso:</span>
                            <p id="detailLastLogin" class="font-medium text-gray-900"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
            <button onclick="closeUserDetailModal()" 
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                <i class="fas fa-times mr-2"></i>
                Cerrar
            </button>
            <button onclick="editUserFromDetail()" 
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                <i class="fas fa-edit mr-2"></i>
                Editar Usuario
            </button>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Eliminación</h3>
            <p class="text-sm text-gray-500 mb-4" id="deleteMessage">
                ¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.
            </p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeDeleteModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancelar
                </button>
                <button onclick="confirmDeleteUser()" 
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='/js/users_crud.js') }}"></script>
<script>
    // Inicializar página de usuarios
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        setupEventListeners();
    });
</script>
{% endblock %}
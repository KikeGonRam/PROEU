{% extends "base.html" %}

{% block title %}Mis Solicitudes - Sistema de Solicitudes de Pagos{% endblock %}

{% block page_title %}Mis Solicitudes{% endblock %}
{% block page_description %}Gestiona y revisa todas tus solicitudes de pago{% endblock %}

{% block header_actions %}
<div class="flex space-x-3">
    <button onclick="crearNuevaSolicitud()" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        <i class="fas fa-plus mr-2"></i>
        Nueva Solicitud
    </button>
    <button onclick="refreshSolicitudes()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        <i class="fas fa-sync-alt mr-2"></i>
        Actualizar
    </button>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Filtros -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="filtroEstado" class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                <select id="filtroEstado" onchange="filtrarSolicitudes()" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Todos los estados</option>
                    <option value="borrador">Borrador</option>
                    <option value="enviada">Enviada</option>
                    <option value="en_revision">En Revisión</option>
                    <option value="aprobada">Aprobada</option>
                    <option value="rechazada">Rechazada</option>
                    <option value="pagada">Pagada</option>
                </select>
            </div>
            <div>
                <label for="filtroTipo" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago</label>
                <select id="filtroTipo" onchange="filtrarSolicitudes()" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Todos los tipos</option>
                    <option value="Proveedores">Proveedores</option>
                    <option value="Póliza - Seguro">Póliza - Seguro</option>
                    <option value="Donativos">Donativos</option>
                    <option value="Operativos">Operativos</option>
                    <option value="Fiscales y Legales">Fiscales y Legales</option>
                </select>
            </div>
            <div>
                <label for="filtroFechaDesde" class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
                <input type="date" id="filtroFechaDesde" onchange="filtrarSolicitudes()" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <label for="filtroFechaHasta" class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
                <input type="date" id="filtroFechaHasta" onchange="filtrarSolicitudes()" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500">
            </div>
        </div>
    </div>

    <!-- Lista de Solicitudes -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-list mr-3 text-blue-600"></i>
                    <h3 class="text-lg font-medium text-gray-900">Listado de Solicitudes</h3>
                    <span id="contadorSolicitudes" class="ml-2 px-2 py-1 bg-gray-100 text-gray-600 text-sm rounded-full"></span>
                </div>
                <div class="flex space-x-3">
                    <button onclick="refreshSolicitudes()" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualizar
                    </button>
                    <button onclick="crearNuevaSolicitud()" 
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-plus mr-2"></i>
                        Nueva Solicitud
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="loadingSolicitudes" class="p-8 text-center">
            <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">Cargando solicitudes...</p>
        </div>

        <!-- Tabla de solicitudes -->
        <div id="tablaSolicitudes" class="hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Beneficiario
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Monto
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tipo
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha Límite
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaSolicitudes" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas se generarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Estado vacío -->
        <div id="solicitudesVacias" class="hidden p-8 text-center">
            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes</h3>
            <p class="text-gray-500 mb-4">No se encontraron solicitudes con los filtros aplicados.</p>
            <button onclick="crearNuevaSolicitud()" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-md hover:bg-primary-700">
                <i class="fas fa-plus mr-2"></i>
                Crear Primera Solicitud
            </button>
        </div>
    </div>
</div>

<!-- Modal de Detalle -->
<div id="modalDetalleSolicitud" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Detalle de Solicitud</h3>
            <button onclick="cerrarModalDetalle()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="contenidoModalDetalle">
            <!-- El contenido se cargará dinámicamente -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables globales
    let solicitudes = [];
    let solicitudesFiltradas = [];

    // Inicializar página
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        // Esperar a que la autenticación esté completa
        waitForAuthentication().then(() => {
            cargarSolicitudes();
        });
    });

    /**
     * Esperar a que la autenticación esté completa
     */
    async function waitForAuthentication() {
        return new Promise((resolve) => {
            const checkAuth = () => {
                if (window.currentUser) {
                    console.log('Autenticación completa, currentUser disponible:', window.currentUser);
                    resolve();
                } else {
                    console.log('Esperando autenticación...');
                    setTimeout(checkAuth, 50);
                }
            };
            checkAuth();
        });
    }

    /**
     * Inicializar página
     */
    function initializePage() {
        // Verificar autenticación
        if (!isAuthenticated) {
            window.location.href = '/login';
            return;
        }

        // Verificar que sea solicitante o administrador
        if (currentUser && currentUser.role !== 'solicitante' && currentUser.role !== 'admin') {
            redirectByRole(currentUser.role);
            return;
        }
    }

    /**
     * Cargar solicitudes desde la API
     */
    async function cargarSolicitudes() {
        try {
            document.getElementById('loadingSolicitudes').classList.remove('hidden');
            document.getElementById('tablaSolicitudes').classList.add('hidden');
            document.getElementById('solicitudesVacias').classList.add('hidden');

            const response = await apiRequest('/solicitudes/mis-solicitudes', {
                method: 'GET'
            });

            solicitudes = response.solicitudes || [];
            solicitudesFiltradas = [...solicitudes];
            
            mostrarSolicitudes();

        } catch (error) {
            console.error('Error cargando solicitudes:', error);
            showAlert('Error al cargar las solicitudes', 'error');
            document.getElementById('loadingSolicitudes').classList.add('hidden');
            document.getElementById('solicitudesVacias').classList.remove('hidden');
        }
    }

    /**
     * Mostrar solicitudes en la tabla
     */
    function mostrarSolicitudes() {
        document.getElementById('loadingSolicitudes').classList.add('hidden');
        
        if (solicitudesFiltradas.length === 0) {
            document.getElementById('tablaSolicitudes').classList.add('hidden');
            document.getElementById('solicitudesVacias').classList.remove('hidden');
            actualizarContador([]);
            return;
        }

        document.getElementById('tablaSolicitudes').classList.remove('hidden');
        document.getElementById('solicitudesVacias').classList.add('hidden');
        
        // Actualizar contador con información específica por rol
        actualizarContador(solicitudesFiltradas);

        const tbody = document.getElementById('cuerpoTablaSolicitudes');
        tbody.innerHTML = solicitudesFiltradas.map(solicitud => crearFilaSolicitud(solicitud)).join('');
    }

    /**
     * Crear fila de la tabla para una solicitud
     */
    function crearFilaSolicitud(solicitud) {
        const fechaCreacion = new Date(solicitud.fecha_creacion).toLocaleDateString('es-ES');
        const fechaLimite = new Date(solicitud.fecha_limite_pago).toLocaleDateString('es-ES');
        const monto = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(solicitud.monto);
        
        console.log('Creando fila para solicitud:', solicitud.id);
        console.log('Estado de la solicitud:', solicitud.estado);
        const userRole = getUserRole();
        console.log('Rol del usuario:', userRole);
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${fechaCreacion}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${solicitud.nombre_beneficiario}</div>
                    <div class="text-sm text-gray-500">${solicitud.nombre_empresa}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${monto}
                    <div class="text-xs text-gray-500">${solicitud.tipo_moneda}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${solicitud.tipo_pago}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${getEstadoBadge(solicitud.estado)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${fechaLimite}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex flex-wrap gap-1">
                        <!-- Botón Ver (siempre disponible) -->
                        <button onclick="verDetalleSolicitud('${solicitud.id}')" 
                                class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors">
                            <i class="fas fa-eye mr-1"></i> Ver
                        </button>
                        
                        <!-- Botones para solicitante -->
                        ${getUserRole() === 'solicitante' || getUserRole() === 'admin' ? `
                            ${(solicitud.estado === 'borrador' || solicitud.estado === 'pendiente') ? `
                                <button onclick="editarSolicitud('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200 transition-colors">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                            ` : ''}
                            ${solicitud.estado === 'borrador' ? `
                                <button onclick="eliminarSolicitud('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 text-xs rounded hover:bg-red-200 transition-colors">
                                    <i class="fas fa-trash mr-1"></i> Eliminar
                                </button>
                                <button onclick="enviarSolicitud('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded hover:bg-purple-200 transition-colors">
                                    <i class="fas fa-paper-plane mr-1"></i> Enviar
                                </button>
                            ` : ''}
                        ` : ''}
                        
                        <!-- Botones para aprobador -->
                        ${(getUserRole() === 'aprobador' || getUserRole() === 'admin') ? `
                            ${solicitud.estado === 'pendiente' ? `
                                <button onclick="aprobarSolicitud('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200 transition-colors">
                                    <i class="fas fa-check mr-1"></i> Aprobar
                                </button>
                                <button onclick="rechazarSolicitud('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 text-xs rounded hover:bg-red-200 transition-colors">
                                    <i class="fas fa-times mr-1"></i> Rechazar
                                </button>
                            ` : ''}
                        ` : ''}
                        
                        <!-- Botones para pagador -->
                        ${(getUserRole() === 'pagador' || getUserRole() === 'admin') ? `
                            ${solicitud.estado === 'aprobada' ? `
                                <button onclick="marcarComoPagada('${solicitud.id}')" 
                                        class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-dollar-sign mr-1"></i> Pagar
                                </button>
                            ` : ''}
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }

    /**
     * Obtener badge de estado
     */
    function getEstadoBadge(estado) {
        const estados = {
            'borrador': { color: 'gray', texto: 'Borrador' },
            'pendiente': { color: 'yellow', texto: 'Pendiente' },
            'aprobada': { color: 'green', texto: 'Aprobada' },
            'rechazada': { color: 'red', texto: 'Rechazada' },
            'pagada': { color: 'blue', texto: 'Pagada' },
            'cancelada': { color: 'gray', texto: 'Cancelada' }
        };

        const estadoInfo = estados[estado] || { color: 'gray', texto: estado };
        
        return `
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-${estadoInfo.color}-100 text-${estadoInfo.color}-800">
                ${estadoInfo.texto}
            </span>
        `;
    }

    /**
     * Obtener rol del usuario actual
     */
    function getUserRole() {
        console.log('getUserRole() called');
        console.log('window.currentUser:', window.currentUser);
        
        // Verificar primero si currentUser está definido globalmente
        if (window.currentUser && window.currentUser.role) {
            console.log('Rol encontrado en window.currentUser:', window.currentUser.role);
            return window.currentUser.role;
        }
        
        // Si no está disponible, intentar decodificar desde el token
        const token = localStorage.getItem('authToken');
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                console.log('Rol encontrado en token:', payload.role);
                return payload.role;
            } catch (e) {
                console.error('Error decodificando token:', e);
            }
        }
        
        console.log('No se pudo obtener el rol del usuario');
        return null;
    }

    /**
     * Actualizar contador con información específica por rol
     */
    function actualizarContador(solicitudes) {
        const total = solicitudes.length;
        const userRole = getUserRole(); // Obtener rol del token
        
        let contadorTexto = `${total} solicitudes`;
        let pendientes = 0;
        
        // Calcular acciones pendientes según el rol
        if (userRole === 'solicitante') {
            pendientes = solicitudes.filter(s => s.estado === 'borrador').length;
            if (pendientes > 0) {
                contadorTexto += ` (${pendientes} borradores por enviar)`;
            }
        } else if (userRole === 'aprobador') {
            pendientes = solicitudes.filter(s => s.estado === 'pendiente').length;
            if (pendientes > 0) {
                contadorTexto += ` (${pendientes} pendientes de aprobación)`;
            }
        } else if (userRole === 'pagador') {
            pendientes = solicitudes.filter(s => s.estado === 'aprobada').length;
            if (pendientes > 0) {
                contadorTexto += ` (${pendientes} aprobadas por pagar)`;
            }
        }
        
        document.getElementById('contadorSolicitudes').textContent = contadorTexto;
    }

    /**
     * Filtrar solicitudes
     */
    function filtrarSolicitudes() {
        const filtroEstado = document.getElementById('filtroEstado').value;
        const filtroTipo = document.getElementById('filtroTipo').value;
        const filtroFechaDesde = document.getElementById('filtroFechaDesde').value;
        const filtroFechaHasta = document.getElementById('filtroFechaHasta').value;

        solicitudesFiltradas = solicitudes.filter(solicitud => {
            // Filtro por estado
            if (filtroEstado && solicitud.estado !== filtroEstado) return false;
            
            // Filtro por tipo
            if (filtroTipo && solicitud.tipo_pago !== filtroTipo) return false;
            
            // Filtro por fecha desde
            if (filtroFechaDesde) {
                const fechaSolicitud = new Date(solicitud.fecha_creacion);
                const fechaDesde = new Date(filtroFechaDesde);
                if (fechaSolicitud < fechaDesde) return false;
            }
            
            // Filtro por fecha hasta
            if (filtroFechaHasta) {
                const fechaSolicitud = new Date(solicitud.fecha_creacion);
                const fechaHasta = new Date(filtroFechaHasta);
                if (fechaSolicitud > fechaHasta) return false;
            }
            
            return true;
        });

        mostrarSolicitudes();
    }

    /**
     * Ver detalle de solicitud
     */
    function verDetalleSolicitud(solicitudId) {
        const solicitud = solicitudes.find(s => s.id === solicitudId);
        if (!solicitud) return;

        const contenido = `
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Beneficiario</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.nombre_beneficiario}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Empresa</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.nombre_empresa}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Monto</label>
                        <p class="mt-1 text-sm text-gray-900">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(solicitud.monto)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Moneda</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.tipo_moneda}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Banco</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.banco_destino}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Cuenta</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.cuenta_destino}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.tipo_pago}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Estado</label>
                        <p class="mt-1">${getEstadoBadge(solicitud.estado)}</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Descripción</label>
                    <p class="mt-1 text-sm text-gray-900">${solicitud.descripcion_tipo_pago}</p>
                </div>
                ${solicitud.comentarios_solicitante ? `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Comentarios</label>
                        <p class="mt-1 text-sm text-gray-900">${solicitud.comentarios_solicitante}</p>
                    </div>
                ` : ''}
                
                <!-- Archivos Adjuntos -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Archivos Adjuntos</label>
                    ${solicitud.archivos_adjuntos && solicitud.archivos_adjuntos.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${solicitud.archivos_adjuntos.map(archivo => crearPrevisualizacionArchivo(archivo)).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                            <i class="fas fa-file-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">No hay archivos adjuntos</p>
                        </div>
                    `}
                </div>
            </div>
        `;

        document.getElementById('contenidoModalDetalle').innerHTML = contenido;
        document.getElementById('modalDetalleSolicitud').classList.remove('hidden');
    }

    /**
     * Crear previsualización de archivo
     */
    function crearPrevisualizacionArchivo(archivo) {
        const fechaSubida = new Date(archivo.fecha_subida).toLocaleDateString('es-ES');
        const tamañoFormateado = formatFileSize(archivo.tamaño);
        const iconoArchivo = getIconoArchivo(archivo.tipo_archivo);
        const esImagen = archivo.tipo_archivo.startsWith('image/');
        
        return `
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow archivo-preview">
                <div class="flex flex-col items-center">
                    ${esImagen ? `
                        <div class="w-full h-32 mb-3 bg-gray-100 rounded-lg overflow-hidden cursor-pointer archivo-image-container" onclick="ampliarImagen('${archivo.ruta_archivo}', '${archivo.nombre_archivo}')">
                            <img src="${construirUrlArchivo(archivo.ruta_archivo)}" 
                                 alt="${archivo.nombre_archivo}" 
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="hidden w-full h-full items-center justify-center bg-gray-200">
                                <i class="${iconoArchivo} text-4xl text-gray-400"></i>
                            </div>
                            <div class="archivo-overlay">
                                <i class="fas fa-eye text-white text-2xl"></i>
                            </div>
                        </div>
                    ` : `
                        <div class="w-16 h-16 mb-3 flex items-center justify-center bg-gray-100 rounded-lg">
                            <i class="${iconoArchivo} text-2xl text-gray-600"></i>
                        </div>
                    `}
                    
                    <div class="text-center w-full">
                        <h4 class="text-sm font-medium text-gray-900 mb-1 truncate tooltip" title="${archivo.nombre_archivo}">
                            ${archivo.nombre_archivo.length > 20 ? archivo.nombre_archivo.substring(0, 20) + '...' : archivo.nombre_archivo}
                        </h4>
                        <p class="text-xs text-gray-500 mb-2">${tamañoFormateado}</p>
                        <p class="text-xs text-gray-400 mb-3">Subido: ${fechaSubida}</p>
                        
                        <div class="flex justify-center space-x-2">
                            <button onclick="descargarArchivo('${archivo.ruta_archivo}', '${archivo.nombre_archivo}')" 
                                    class="btn-archivo inline-flex items-center px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-download mr-1"></i>
                                Descargar
                            </button>
                            ${esImagen ? `
                                <button onclick="ampliarImagen('${archivo.ruta_archivo}', '${archivo.nombre_archivo}')" 
                                        class="btn-archivo inline-flex items-center px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>
                                    Ver
                                </button>
                            ` : `
                                <button onclick="previsualizarArchivo('${archivo.ruta_archivo}', '${archivo.nombre_archivo}', '${archivo.tipo_archivo}')" 
                                        class="btn-archivo inline-flex items-center px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>
                                    Ver
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Obtener icono según tipo de archivo
     */
    function getIconoArchivo(tipoArchivo) {
        if (tipoArchivo.startsWith('image/')) return 'fas fa-image';
        if (tipoArchivo === 'application/pdf') return 'fas fa-file-pdf';
        if (tipoArchivo.includes('word')) return 'fas fa-file-word';
        if (tipoArchivo.includes('excel') || tipoArchivo.includes('spreadsheet')) return 'fas fa-file-excel';
        if (tipoArchivo.includes('powerpoint') || tipoArchivo.includes('presentation')) return 'fas fa-file-powerpoint';
        return 'fas fa-file-alt';
    }

    /**
     * Formatear tamaño de archivo
     */
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /**
     * Descargar archivo
     */
    function descargarArchivo(rutaArchivo, nombreArchivo) {
        const link = document.createElement('a');
        link.href = construirUrlArchivo(rutaArchivo);
        link.download = nombreArchivo;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /**
     * Ampliar imagen en modal
     */
    function ampliarImagen(rutaArchivo, nombreArchivo) {
        const modalContent = `
            <div class="text-center">
                <img src="${construirUrlArchivo(rutaArchivo)}" 
                     alt="${nombreArchivo}" 
                     class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                <h3 class="mt-4 text-lg font-medium text-gray-900">${nombreArchivo}</h3>
                <div class="mt-4 flex justify-center space-x-3">
                    <button onclick="descargarArchivo('${rutaArchivo}', '${nombreArchivo}')" 
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>
                        Descargar
                    </button>
                    <button onclick="cerrarModalPreview()" 
                            class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                        <i class="fas fa-times mr-2"></i>
                        Cerrar
                    </button>
                </div>
            </div>
        `;
        
        mostrarModalPreview(modalContent);
    }

    /**
     * Previsualizar archivo (PDF, documentos)
     */
    function previsualizarArchivo(rutaArchivo, nombreArchivo, tipoArchivo) {
        let contenido = '';
        
        if (tipoArchivo === 'application/pdf') {
            contenido = `
                <div class="text-center">
                    <iframe src="${construirUrlArchivo(rutaArchivo)}" 
                            class="w-full h-96 border rounded-lg mb-4"></iframe>
                    <h3 class="text-lg font-medium text-gray-900">${nombreArchivo}</h3>
                    <div class="mt-4 flex justify-center space-x-3">
                        <button onclick="descargarArchivo('${rutaArchivo}', '${nombreArchivo}')" 
                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>
                            Descargar
                        </button>
                        <button onclick="cerrarModalPreview()" 
                                class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                            <i class="fas fa-times mr-2"></i>
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
        } else {
            contenido = `
                <div class="text-center py-8">
                    <i class="${getIconoArchivo(tipoArchivo)} text-6xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">${nombreArchivo}</h3>
                    <p class="text-gray-500 mb-6">No se puede previsualizar este tipo de archivo</p>
                    <div class="flex justify-center space-x-3">
                        <button onclick="descargarArchivo('${rutaArchivo}', '${nombreArchivo}')" 
                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>
                            Descargar
                        </button>
                        <button onclick="cerrarModalPreview()" 
                                class="inline-flex items-center px-4 py-2 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                            <i class="fas fa-times mr-2"></i>
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
        }
        
        mostrarModalPreview(contenido);
    }

    /**
     * Mostrar modal de preview
     */
    function mostrarModalPreview(contenido) {
        // Crear modal si no existe
        let modal = document.getElementById('modalPreviewArchivo');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalPreviewArchivo';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden modal-preview-backdrop';
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white modal-preview-content modal-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">Vista Previa de Archivo</h3>
                        <button onclick="cerrarModalPreview()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="contenidoModalPreview">
                        <!-- El contenido se cargará dinámicamente -->
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById('contenidoModalPreview').innerHTML = contenido;
        modal.classList.remove('hidden');
    }

    /**
     * Cerrar modal de preview
     */
    function cerrarModalPreview() {
        const modal = document.getElementById('modalPreviewArchivo');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    /**
     * Cerrar modal de detalle
     */
    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').classList.add('hidden');
    }

    /**
     * Construir URL correcta para archivos
     */
    function construirUrlArchivo(rutaArchivo) {
        // Si la ruta ya incluye uploads/solicitudes, usarla directamente
        if (rutaArchivo.startsWith('uploads/solicitudes/')) {
            return `/${encodeURIComponent(rutaArchivo)}`;
        }
        // Si no, asumir que es solo el nombre del archivo
        return `/uploads/solicitudes/${encodeURIComponent(rutaArchivo)}`;
    }

    /**
     * Editar solicitud
     */
    function editarSolicitud(solicitudId) {
        window.location.href = `/solicitud-estandar/editar?id=${solicitudId}`;
    }

    /**
     * Eliminar solicitud
     */
    async function eliminarSolicitud(solicitudId) {
        if (!confirm('¿Estás seguro de que deseas eliminar esta solicitud? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            showAlert('Eliminando solicitud...', 'info');
            
            const response = await apiRequest(`/solicitudes/estandar/${solicitudId}`, {
                method: 'DELETE'
            });

            if (response && response.message) {
                showAlert('Solicitud eliminada exitosamente', 'success');
                // Recargar la lista de solicitudes
                cargarSolicitudes();
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('Error eliminando solicitud:', error);
            showAlert('Error al eliminar la solicitud: ' + error.message, 'error');
        }
    }

    /**
     * Crear nueva solicitud
     */
    function crearNuevaSolicitud() {
        window.location.href = '/solicitud-estandar/nueva';
    }

    /**
     * Refrescar solicitudes
     */
    function refreshSolicitudes() {
        cargarSolicitudes();
        showAlert('Solicitudes actualizadas', 'success');
    }

    /**
     * Enviar solicitud (cambiar estado de borrador a pendiente)
     */
    async function enviarSolicitud(solicitudId) {
        if (!confirm('¿Estás seguro de que deseas enviar esta solicitud? Una vez enviada no podrás eliminarla.')) {
            return;
        }

        try {
            showAlert('Enviando solicitud...', 'info');
            
            const response = await apiRequest(`/solicitudes/estandar/${solicitudId}/estado?nuevo_estado=pendiente`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response && response.message) {
                showAlert('Solicitud enviada exitosamente', 'success');
                cargarSolicitudes(); // Recargar lista
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('Error enviando solicitud:', error);
            showAlert('Error al enviar la solicitud: ' + error.message, 'error');
        }
    }

    /**
     * Aprobar solicitud
     */
    async function aprobarSolicitud(solicitudId) {
        const comentarios = prompt('Comentarios de aprobación (opcional):');
        
        try {
            showAlert('Aprobando solicitud...', 'info');
            
            let url = `/solicitudes/estandar/${solicitudId}/estado?nuevo_estado=aprobada`;
            if (comentarios && comentarios.trim()) {
                url += `&comentarios=${encodeURIComponent(comentarios.trim())}`;
            }
            
            const response = await apiRequest(url, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response && response.message) {
                showAlert('Solicitud aprobada exitosamente', 'success');
                cargarSolicitudes(); // Recargar lista
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('Error aprobando solicitud:', error);
            showAlert('Error al aprobar la solicitud: ' + error.message, 'error');
        }
    }

    /**
     * Rechazar solicitud
     */
    async function rechazarSolicitud(solicitudId) {
        const comentarios = prompt('Motivo del rechazo (requerido):');
        
        if (!comentarios || !comentarios.trim()) {
            showAlert('Debes proporcionar un motivo para el rechazo', 'warning');
            return;
        }
        
        try {
            showAlert('Rechazando solicitud...', 'info');
            
            const url = `/solicitudes/estandar/${solicitudId}/estado?nuevo_estado=rechazada&comentarios=${encodeURIComponent(comentarios.trim())}`;
            
            const response = await apiRequest(url, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response && response.message) {
                showAlert('Solicitud rechazada', 'success');
                cargarSolicitudes(); // Recargar lista
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('Error rechazando solicitud:', error);
            showAlert('Error al rechazar la solicitud: ' + error.message, 'error');
        }
    }

    /**
     * Marcar solicitud como pagada
     */
    async function marcarComoPagada(solicitudId) {
        const comentarios = prompt('Comentarios del pago (opcional - número de transferencia, etc.):');
        
        if (!confirm('¿Confirmas que se ha realizado el pago de esta solicitud?')) {
            return;
        }
        
        try {
            showAlert('Marcando como pagada...', 'info');
            
            let url = `/solicitudes/estandar/${solicitudId}/estado?nuevo_estado=pagada`;
            if (comentarios && comentarios.trim()) {
                url += `&comentarios=${encodeURIComponent(comentarios.trim())}`;
            }
            
            const response = await apiRequest(url, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response && response.message) {
                showAlert('Solicitud marcada como pagada', 'success');
                cargarSolicitudes(); // Recargar lista
            } else {
                throw new Error('Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('Error marcando como pagada:', error);
            showAlert('Error al marcar como pagada: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}